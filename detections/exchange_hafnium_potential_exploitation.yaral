rule exchange_hafnium_potential_exploitation {
  meta:
    author = "Dan Lussier"
    description = "HAFNIUM targeting exchange, umworker and umservice shouldn't spawn child processes that are not themselves"
    version = "1.0"
    severity = "High"
    mitre_TA = "TA0001"
    mitre_T1 = "T1190"
    mitre_url = "https://attack.mitre.org/techniques/T1190/"
    references = "https://www.microsoft.com/security/blog/2021/03/02/hafnium-targeting-exchange-servers/"

  events:

    $e1.metadata.event_type = "PROCESS_LAUNCH"
        $e1.principal.process.file.full_path = /.*umworkerprocess.exe.*/ nocase or
        $e1.principal.process.file.full_path = /.*umservice.exe.*/ nocase
        $e1.target.process.command_line != /.*umworkerprocess.exe.*/ nocase
        $e1.target.process.command_line != /.*umservice.exe.*/ nocase
    $e1.principal.hostname = $hostname

  match:
   $hostname over 1m

  condition:
   $e1
}
